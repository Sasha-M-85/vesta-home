
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–ª–∏–µ–Ω—Ç</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 2rem; font-family: sans-serif; }
    .readonly input { background-color: #f8f9fa; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="client-title">–ö–ª–∏–µ–Ω—Ç: –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</h2>

    
    </div>

    
<div class="accordion mb-4" id="clientAccordion">

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingContact">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact" aria-expanded="true">
        üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      </button>
    </h2>
    <div id="collapseContact" class="accordion-collapse collapse show" data-bs-parent="#clientAccordion">
      <div class="accordion-body">
        <div class="mb-3">
          <label class="form-label">–ò–º—è *</label>
          <input id="client-name" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input id="client-phone" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="client-phone2" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input id="client-email" class="form-control" />
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingAddress">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddress">
        üè† –ê–¥—Ä–µ—Å
      </button>
    </h2>
    <div id="collapseAddress" class="accordion-collapse collapse" data-bs-parent="#clientAccordion">
      <div class="accordion-body">
        <div class="mb-3">
          <label class="form-label">–ì–æ—Ä–æ–¥</label>
          <input id="client-city" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞</label>
          <input id="client-address" class="form-control" />
        </div>
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingNotes">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotes">
        üìù –ó–∞–º–µ—Ç–∫–∏
      </button>
    </h2>
    <div id="collapseNotes" class="accordion-collapse collapse" data-bs-parent="#clientAccordion">
      <div class="accordion-body">
        <textarea id="client-notes" class="form-control" rows="3"></textarea>
      </div>
    </div>
  </div>
</div>

<a href="clients.html" class="btn btn-link">&larr; –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
  </div>

  
  <script>
    const SUPABASE_URL = 'https://rincxoalnhfsnwgwxrfb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpbmN4b2Fsbmhmc253Z3d4cmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjE2MzMsImV4cCI6MjA2OTE5NzYzM30.95JhUW9uRbcHSkFCXyh40acSAAnJIj3nbUICQGqW32Y';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const clientId = new URLSearchParams(window.location.search).get('id');

    async function loadClient() {
      const { data, error } = await supabase.from('clients').select('*').eq('id', clientId).single();
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:', error);
        return;
      }
      document.getElementById('client-name').value = data.name;
      document.getElementById('client-phone').value = data.phone;
      document.getElementById('client-created').innerText = data.created_at?.split('T')[0];
      document.getElementById('client-title').innerText = `–ö–ª–∏–µ–Ω—Ç: ${data.name}`;
    }

    document.getElementById('edit-btn').addEventListener('click', () => {
      document.getElementById('client-name').disabled = false;
      document.getElementById('client-phone').disabled = false;
    });

    loadClient();
  </script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://rincxoalnhfsnwgwxrfb.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpbmN4b2Fsbmhmc253Z3d4cmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjE2MzMsImV4cCI6MjA2OTE5NzYzM30.95JhUW9uRbcHSkFCXyh40acSAAnJIj3nbUICQGqW32Y'

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  const clientId = new URLSearchParams(window.location.search).get('id')

  async function loadClient() {
    const { data, error } = await supabase
      .from('clients')
      .select('*')
      .eq('id', clientId)
      .single()

    if (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:', error)
      return
    }

    document.getElementById('client-name').value = data.name
    document.getElementById('client-phone').value = data.phone
    document.getElementById('client-created').innerText = data.created_at?.split('T')[0]
    document.getElementById('client-title').innerText = `–ö–ª–∏–µ–Ω—Ç: ${data.name}`
  }

  document.getElementById('edit-btn').addEventListener('click', () => {
    document.getElementById('client-name').disabled = false
    document.getElementById('client-phone').disabled = false
  })

  loadClient()


  const deleteBtn = document.getElementById('delete-btn');

  document.getElementById('edit-btn').addEventListener('click', () => {
    deleteBtn.style.display = 'inline-block';
  });

  deleteBtn.addEventListener('click', async () => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) return;

    const { error } = await supabase
      .from('clients')
      .delete()
      .eq('id', clientId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞.');
      console.error(error);
      return;
    }

    alert('–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω.');
    window.location.href = 'clients.html'; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
  });


  const saveBtn = document.getElementById('save-btn');
  const nameInput = document.getElementById('client-name');
  const phoneInput = document.getElementById('client-phone');

  document.getElementById('edit-btn').addEventListener('click', () => {
    nameInput.disabled = false;
    phoneInput.disabled = false;
    saveBtn.style.display = 'inline-block';
  });

  saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
    const updatedName = nameInput.value.trim();
    const updatedPhone = phoneInput.value.trim();

    const { error } = await supabase
      .from('clients')
      .update({ name: updatedName, phone: updatedPhone })
      .eq('id', clientId);

    if (error) {
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.');
      console.error(error);
      return;
    }

    nameInput.disabled = true;
    phoneInput.disabled = true;
    saveBtn.style.display = 'none';
    alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
  });


  // --- –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ---
  if (!clientId) {
    document.getElementById('client-title').innerText = '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
    document.getElementById('edit-btn').style.display = 'none';
    document.getElementById('delete-btn').style.display = 'none';
    document.getElementById('save-btn').style.display = 'inline-block';
    document.getElementById('client-name').disabled = false;
    document.getElementById('client-phone').disabled = false;

    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      if (!name || !phone) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω');
        return;
      }

      
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –∫–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º
    const { data: existing } = await supabase
      .from('clients')
      .select('*')
      .or(`name.eq.${name},phone.eq.${phone}`);

    if (existing.length > 0) {
      alert("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
      return;
    }

    const { data, error } = await supabase
        .from('clients')
        .insert([{ name, phone }]);

      if (error || !data) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞.');
        return;
      }

      alert('–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
      window.location.href = 'clients.html';
    });
  }

</script>

</body>
</html>
