
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Клиент</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 2rem; font-family: sans-serif; }
    .readonly input { background-color: #f8f9fa; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="client-title">Клиент: Имя клиента</h2>

    <div class="mb-3">
      <label class="form-label">Имя</label>
      <input id="client-name" class="form-control" disabled />
    </div>

    <div class="mb-3">
      <label class="form-label">Телефон</label>
      <input id="client-phone" class="form-control" disabled />
    </div>

    <div class="mb-3">
      <strong>Создан:</strong> <span id="client-created"></span>
    </div>

    
    <button id="edit-btn" class="btn btn-primary mb-3">Редактировать данные</button>
    
    <button id="save-btn" class="btn btn-success mb-3 ms-2" style="display:none;">Сохранить изменения</button>
    <button id="delete-btn" class="btn btn-danger mb-3 ms-2" style="display:none;">Удалить клиента</button>
    
    

    <div class="mb-3">
      <label class="form-label">Путь к папке Dropbox</label>
      <input id="client-dropbox-path" class="form-control" />
      <button class="btn btn-secondary mt-2">Выбрать папку</button>
    </div>

    <div class="mb-4">
      <h5>Файлы клиента</h5>
      <div id="client-files" class="border p-3 bg-light">Нет файлов</div>
    </div>

    <a href="clients.html" class="btn btn-link">&larr; Назад к списку клиентов</a>
  </div>

  
  <script>
    const SUPABASE_URL = 'https://rincxoalnhfsnwgwxrfb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpbmN4b2Fsbmhmc253Z3d4cmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjE2MzMsImV4cCI6MjA2OTE5NzYzM30.95JhUW9uRbcHSkFCXyh40acSAAnJIj3nbUICQGqW32Y';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const clientId = new URLSearchParams(window.location.search).get('id');

    async function loadClient() {
      const { data, error } = await supabase.from('clients').select('*').eq('id', clientId).single();
      if (error) {
        console.error('Ошибка загрузки клиента:', error);
        return;
      }
      document.getElementById('client-name').value = data.name;
      document.getElementById('client-phone').value = data.phone;
      document.getElementById('client-created').innerText = data.created_at?.split('T')[0];
      document.getElementById('client-title').innerText = `Клиент: ${data.name}`;
    }

    document.getElementById('edit-btn').addEventListener('click', () => {
      document.getElementById('client-name').disabled = false;
      document.getElementById('client-phone').disabled = false;
    });

    loadClient();
  </script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://rincxoalnhfsnwgwxrfb.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpbmN4b2Fsbmhmc253Z3d4cmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjE2MzMsImV4cCI6MjA2OTE5NzYzM30.95JhUW9uRbcHSkFCXyh40acSAAnJIj3nbUICQGqW32Y'

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  const clientId = new URLSearchParams(window.location.search).get('id')

  async function loadClient() {
    const { data, error } = await supabase
      .from('clients')
      .select('*')
      .eq('id', clientId)
      .single()

    if (error) {
      console.error('Ошибка загрузки клиента:', error)
      return
    }

    document.getElementById('client-name').value = data.name
    document.getElementById('client-phone').value = data.phone
    document.getElementById('client-created').innerText = data.created_at?.split('T')[0]
    document.getElementById('client-title').innerText = `Клиент: ${data.name}`
  }

  document.getElementById('edit-btn').addEventListener('click', () => {
    document.getElementById('client-name').disabled = false
    document.getElementById('client-phone').disabled = false
  })

  loadClient()


  const deleteBtn = document.getElementById('delete-btn');

  document.getElementById('edit-btn').addEventListener('click', () => {
    deleteBtn.style.display = 'inline-block';
  });

  deleteBtn.addEventListener('click', async () => {
    if (!confirm('Вы уверены, что хотите удалить этого клиента?')) return;

    const { error } = await supabase
      .from('clients')
      .delete()
      .eq('id', clientId);

    if (error) {
      alert('Ошибка при удалении клиента.');
      console.error(error);
      return;
    }

    alert('Клиент удалён.');
    window.location.href = 'clients.html'; // возвращаемся к списку
  });


  const saveBtn = document.getElementById('save-btn');
  const nameInput = document.getElementById('client-name');
  const phoneInput = document.getElementById('client-phone');

  document.getElementById('edit-btn').addEventListener('click', () => {
    nameInput.disabled = false;
    phoneInput.disabled = false;
    saveBtn.style.display = 'inline-block';
  });

  saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
    const updatedName = nameInput.value.trim();
    const updatedPhone = phoneInput.value.trim();

    const { error } = await supabase
      .from('clients')
      .update({ name: updatedName, phone: updatedPhone })
      .eq('id', clientId);

    if (error) {
      alert('Ошибка сохранения данных.');
      console.error(error);
      return;
    }

    nameInput.disabled = true;
    phoneInput.disabled = true;
    saveBtn.style.display = 'none';
    alert('Данные успешно сохранены!');
  });


  // --- Режим создания нового клиента ---
  if (!clientId) {
    document.getElementById('client-title').innerText = 'Новый клиент';
    document.getElementById('edit-btn').style.display = 'none';
    document.getElementById('delete-btn').style.display = 'none';
    document.getElementById('save-btn').style.display = 'inline-block';
    document.getElementById('client-name').disabled = false;
    document.getElementById('client-phone').disabled = false;

    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      if (!name || !phone) {
        alert('Введите имя и телефон');
        return;
      }

      const { data, error } = await supabase
        .from('clients')
        .insert([{ name, phone }]);

      if (error || !data) {
        console.error('Ошибка при создании:', error);
        alert('Ошибка при создании клиента.');
        return;
      }

      alert('Клиент успешно создан!');
      window.location.href = 'clients.html';
    });
  }

</script>

</body>
</html>
